# - set_fact:
#     updated_vm_info:
#         instance_name: "{{loop_item.key}}" 
#         vm_name: "{{ loop_item.key | replace('_', '') }}"
#         resource_group_name: "{{loop_item.value['resourcegroup']}}"
#         flavor: "{{loop_item.value['flavor_name']}}"
#         user_name: "{{loop_item.value['user_name']}}"
#         network_interface_name: "{{loop_item.value['resourcegroup']}}"
#         os_distro: "{{loop_item.value['os_distro']}}"
#         os_version: "{{loop_item.value['os_version']}}"
#         publisher_name: "{{loop_item.value['image']['publisher_name']}}"
#         public_key: "{{ loop_item.value['user_key_pair']['keys']['public_key'] | b64decode }}"
#   loop: "{{ vm_info }}"
#   loop_control:
#     loop_var: "loop_item"



- set_fact:
    os_distro:
        instance_name: "{{loop_item.key}}" 
        updated_os_distro: UbuntuServer
  loop: "{{ vm_info }}"
  loop_control:
    loop_var: "loop_item"
  when: loop_item.value['os_distro'] == "Ubuntu"
    
- set_fact:
    os_distro:
        instance_name: "{{loop_item.key}}" 
        updated_os_distro: "{{os_distro}}"
  when: loop_item.value['os_distro'] != "Ubuntu"
  loop: "{{ vm_info }}"
  loop_control:
    loop_var: "loop_item"
    
  
- set_fact:
    os_version:
        instance_name: "{{loop_item.key}}" 
        updated_os_version: 18.04-LTS
  loop: "{{ vm_info }}"
  loop_control:
    loop_var: "loop_item"
  when: loop_item.value['os_version'] == "18.04" 
  
  
- set_fact:
    os_version:
        instance_name: "{{loop_item.key}}" 
        updated_os_version: "{{os_version}}"
  loop: "{{ vm_info }}"
  loop_control:
    loop_var: "loop_item"
  when: loop_item.value['os_version'] == "18.04" 
  
- debug: msg="{{ item.key }} = {{ item.value }}"
  with_dict: "{{ os_version | combine(os_distro) }}"
  
  

- name: Async sleeping for batched_items
  ansible.builtin.command: echo {{ async_item }}
  async: 2400
  poll: 0
  loop: "{{ vm_info }}"
  loop_control:
    loop_var: "async_item"
  register: async_results

- name: Check sync status
  async_status:
    jid: "{{ async_result_item.ansible_job_id }}"
  loop: "{{ async_results.results }}"
  loop_control:
    loop_var: "async_result_item"
  register: async_poll_results
  until: async_poll_results.finished
  retries: 30
  

# - set_fact:
#     updated_os_distro: UbuntuServer
#   when: os_distro == "Ubuntu"
  
# - set_fact:
#     updated_os_distro: "{{os_distro}}"
#   when: os_distro != "Ubuntu"
  
# - set_fact:
#     updated_os_version: 18.04-LTS
#   when: os_version == "18.04"
  
# - set_fact:
#     updated_os_version: "{{os_version}}"
#   when: os_version != "18.04"
  

# - azure_rm_virtualmachine:
#     resource_group: "{{ resource_group_name }}"
#     name: "{{ vm_name }}"
#     admin_username: "{{ user_name}}"
#     ssh_password_enabled: false
#     image:
#       offer: "{{ updated_os_distro }}"
#       publisher: "{{publisher_name}}"
#       sku: "{{ updated_os_version }}"
#       version: latest
#     ssh_public_keys:
#       - path: /home/{{ user_name}}/.ssh/authorized_keys
#         key_data: "{{public_key}}"
#     vm_size: "{{flavor}}"
#     open_ports:
#       - 22
#       - 80
#       - 443
#       - 8080
#       - 6443
#       - 30000-32767
#   register: vm_output
#   async: 2400
#   poll: 0
#   loop: "{{ vms | dict2items | batch(2) | list}}"
#   loop_control:
#     loop_var: "async_item"

    
# - local_action: copy content={{ vm_output }} dest=/tmp/vm_output.json

# - shell:  jq '.ansible_facts.azure_vm.properties | {"{{ item.key }}":{public_ip:.networkProfile.networkInterfaces[0].properties.ipConfigurations[0].properties.publicIPAddress.properties.ipAddress,node_type:.hardwareProfile.vmSize}}' /tmp/vm_output.json
#   register: vm_provision_attributes
  
     
# - set_stats:
#     data:
#       vm: "{{ vm_provision_attributes.stdout }}"
      


# - name: Check sync status
#   async_status:
#     jid: "{{ async_result_item.ansible_job_id }}"
#   loop: "{{ async_results.results }}"
#   loop_control:
#     loop_var: "async_result_item"
#   register: async_poll_results
#   until: async_poll_results.finished
#   retries: 50
  
# - debug:
#     var: async_vm_output
